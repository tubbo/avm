#!/usr/bin/env zsh
#
# anything version manager

if [ -z "$DOCKER_COMMAND" ]; then
  DOCKER_COMMAND="docker"
fi

if [[ "$(which $DOCKER_COMMAND)" =~ "not found" ]]; then
  echo "Error: avm requires Docker to be installed."
  exit 1
fi

if [ -z "$1" ]; then
  echo "Usage: avm SERVICE [VERSION] [OPTIONS]"
  exit 1
fi

if [ -f $PWD/.esvmrc ]; then
  avmrc="$PWD/.esvmrc"
else
  avmrc="$PWD/.avmrc"
fi

service=$1

if [ -z "$2" && -f "$avmrc" ]; then
  version=$(cat $avmrc | jq '.defaults.version' | sed 's/\"//g')
else
  version=$2
fi

if [ -z "$version" ]; then
  version='latest'
fi

if [ -f "$HOME/.avm/$service" ]; then
  args="$(cat $HOME/.avm/$service)"
fi

if [ "$#" -gt 2 ]; then
  args=$argv[3,-1]
fi

pull="docker image pull $service:$version"
cmd="docker run -it $args $service:$version"

if [ $AVM_DRY_RUN ]; then
  echo $pul
  echo $cmd
else
  $pull && $cmd
fi
